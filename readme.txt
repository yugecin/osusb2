Note: (most of) the code is horrible and disgusting. It's not meant
to be reused (although I said the same last time and I copied that
to make this) and I just wanted this done with.